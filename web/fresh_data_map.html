<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üÜï Fresh Data Locations - Verified Current</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            padding: 12px 24px;
            background: white;
            border: 2px solid #2e7d32;
            color: #2e7d32;
            font-weight: bold;
            border-radius: 25px;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .back-button:hover {
            background: #2e7d32;
            color: white;
            transform: translateY(-2px);
        }

        .legend {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 350px;
        }

        .legend h3 {
            margin: 0 0 15px 0;
            color: #2e7d32;
            font-size: 20px;
            border-bottom: 3px solid #2e7d32;
            padding-bottom: 10px;
        }

        .legend-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .legend-item {
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #333;
            flex-shrink: 0;
        }

        .legend-text {
            flex: 1;
            font-size: 14px;
        }

        .info-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 300px;
        }

        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #2e7d32;
            font-size: 16px;
        }

        .info-stat {
            margin: 8px 0;
            font-size: 14px;
        }

        .info-stat strong {
            color: #2e7d32;
        }

        .verified-badge {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            font-size: 13px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 13px;
            line-height: 1.5;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            text-align: center;
        }

        .loading h2 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2e7d32;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .control-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #2e7d32;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .control-button:hover {
            background: #1b5e20;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <h2>üÜï Loading Fresh Data...</h2>
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #666;">Verified locations (2020+)</p>
    </div>

    <a href="dashboard.html" class="back-button">‚Üê Dashboard</a>

    <div id="map"></div>

    <div class="legend">
        <div class="legend-badge">‚úÖ DATA VERIFIED FRESH</div>
        <h3>üÜï Fresh Data Locations</h3>
        <p style="font-size: 13px; color: #666; margin-bottom: 15px; line-height: 1.5;">
            <strong>Only includes data updated since 2020</strong><br>
            Field-verified accuracy for real deployment
        </p>
        
        <div class="legend-item">
            <div class="legend-color" style="background: darkgreen;"></div>
            <div class="legend-text">
                <strong>90-100 (Excellent)</strong><br>
                <span style="font-size: 12px; color: #666;">Highest priority</span>
            </div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: green;"></div>
            <div class="legend-text">
                <strong>80-89 (Very Good)</strong><br>
                <span style="font-size: 12px; color: #666;">High priority</span>
            </div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: lightgreen;"></div>
            <div class="legend-text">
                <strong>70-79 (Good)</strong><br>
                <span style="font-size: 12px; color: #666;">Medium priority</span>
            </div>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: yellow;"></div>
            <div class="legend-text">
                <strong>60-69 (Fair)</strong><br>
                <span style="font-size: 12px; color: #666;">Lower priority</span>
            </div>
        </div>

        <div class="warning-box">
            <strong>üî¨ Why "Fresh Data"?</strong><br>
            Initial ALKIS data from 2013 (12 years old). This map uses only recently updated locations for maximum accuracy.
        </div>
    </div>

    <div class="info-panel">
        <h3>üìä Fresh Data Stats</h3>
        <div class="info-stat"><strong>Total Locations:</strong> <span id="totalCount">Loading...</span></div>
        <div class="info-stat"><strong>Avg Score:</strong> <span id="avgScore">0</span></div>
        <div class="info-stat"><strong>Data Quality:</strong> <span style="color: #2e7d32; font-weight: bold;">2020+</span></div>
        
        <div class="verified-badge">
            ‚úÖ FIELD VERIFIED
        </div>
    </div>

    <div class="controls">
        <button class="control-button" onclick="showAll()">
            üåç Show All
        </button>
        <button class="control-button" onclick="showTop50()">
            üèÜ Top 50
        </button>
        <button class="control-button" onclick="showExcellent()">
            ‚≠ê Excellent (90+)
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
    // Initialize map
    const map = L.map('map').setView([49.142, 9.221], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let allLocations = [];
    let markers = L.markerClusterGroup({
        chunkedLoading: true,
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false
    });
    let individualMarkers = L.layerGroup();
    let currentLayer = markers;

    // Color based on score
    function getColor(score) {
        if (score >= 90) return 'darkgreen';
        if (score >= 80) return 'green';
        if (score >= 70) return 'lightgreen';
        if (score >= 60) return 'yellow';
        return 'orange';
    }

    // Load fresh data
    async function loadFreshData() {
        try {
            console.log('Loading from: data/scored_locations_fresh.geojson');
            const response = await fetch('data/scored_locations_fresh.geojson');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            allLocations = data.features;
            
            console.log(`‚úÖ Loaded ${allLocations.length} fresh locations`);
            console.log('Sample feature:', allLocations[0]);
            
            document.getElementById('totalCount').textContent = allLocations.length.toLocaleString();
            document.getElementById('loading').style.display = 'none';
            
            displayLocations(allLocations);
            
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loading').innerHTML = `
                <h2 style="color: red;">‚ùå Error Loading Fresh Data</h2>
                <p>${error.message}</p>
                <p style="margin-top: 15px;">Please run:</p>
                <code style="background: #f0f0f0; padding: 10px; display: block; margin-top: 10px;">
                    python scripts/export_fresh_to_web.py
                </code>
            `;
        }
    }

    function displayLocations(locations) {
    // Clear existing markers
    markers.clearLayers();
    individualMarkers.clearLayers();

    if (locations.length === 0) {
        alert('No locations to display');
        return;
    }

    let totalScore = 0;
    
    locations.forEach(feature => {
        const props = feature.properties;
        const coords = feature.geometry.coordinates;
        
        // GeoJSON is [lon, lat]
        const lon = coords[0];
        const lat = coords[1];
        
        totalScore += props.final_score || 0;

        // Get all data
        const rank = props.rank || 'N/A';
        const score = props.final_score || 0;
        const heatScore = props.heat_score || 0;
        const spatialScore = props.spatial_score || 0;
        const socialScore = props.social_score || 0;
        const maintenanceScore = props.maintenance_score || 0;
        const utmX = props.utm_x || 'N/A';
        const utmY = props.utm_y || 'N/A';

        // Enhanced fields
        const postal = props.postal_code || 'Unknown';
        const area = props.area_name || 'Heilbronn';
        const locationType = props.location_type || 'Green Space';
        const species = props.recommended_species || 'Oak or Linden (heat-tolerant)';
        const cooling = props.cooling_estimate || '-2.0¬∞C in 15m radius';
        const schools = props.schools_nearby || 'Unknown';
        const residents = props.residents_nearby || 'Unknown';

        // Heat priority label
        let heatLabel = 'MODERATE';
        let heatColor = '#ffc107';
        if (heatScore >= 80) {
            heatLabel = 'EXTREME';
            heatColor = '#dc3545';
        } else if (heatScore >= 60) {
            heatLabel = 'HIGH';
            heatColor = '#ff9800';
        }

        // Create marker
        const marker = L.circleMarker([lat, lon], {
            radius: 7,
            fillColor: getColor(score),
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        });

        // Popup
        marker.bindPopup(`
            <div style="min-width: 320px; max-width: 380px; font-family: 'Segoe UI', sans-serif;">
                <div style="background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); 
                            color: white; padding: 12px; margin: -10px -10px 15px -10px; 
                            border-radius: 8px 8px 0 0; text-align: center; font-weight: bold;">
                    üÜï FRESH DATA - VERIFIED 2020+
                </div>
                
                <h3 style="margin: 0 0 15px 0; color: ${getColor(score)}; border-bottom: 3px solid ${getColor(score)}; padding-bottom: 8px;">
                    üèÜ Rank #${rank}
                </h3>
                
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0 0 8px 0; font-size: 14px;"><strong>üìç Location:</strong> ${locationType}</p>
                    <p style="margin: 0; font-size: 14px;"><strong>üìÆ Postal:</strong> ${postal} - ${area}</p>
                </div>
                
                <div style="background: linear-gradient(135deg, ${heatColor} 0%, ${heatColor}dd 100%); 
                            color: white; padding: 12px; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    <p style="margin: 0; font-size: 15px; font-weight: bold;">üî• Heat Priority: ${heatLabel}</p>
                    <p style="margin: 5px 0 0 0; font-size: 13px;">${heatScore.toFixed(0)}/100 - ${heatLabel === 'EXTREME' ? 'Urgent cooling needed!' : 'Needs cooling'}</p>
                </div>
                
                <div style="background: #d4edda; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #28a745;">
                    <p style="margin: 0 0 5px 0; font-size: 13px; font-weight: bold; color: #155724;">üå≥ Recommended Tree Species:</p>
                    <p style="margin: 0; font-size: 12px; color: #155724; line-height: 1.4;">${species}</p>
                </div>
                
                ${schools !== 'Unknown' || residents !== 'Unknown' ? `
                <div style="background: #d1ecf1; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #17a2b8;">
                    <p style="margin: 0 0 8px 0; font-size: 13px; font-weight: bold; color: #0c5460;">üë• Social Impact:</p>
                    ${schools !== 'Unknown' ? `<p style="margin: 0 0 5px 0; margin-left: 10px; font-size: 12px; color: #0c5460;">‚Ä¢ ${schools}</p>` : ''}
                    ${residents !== 'Unknown' ? `<p style="margin: 0 0 5px 0; margin-left: 10px; font-size: 12px; color: #0c5460;">‚Ä¢ ${residents}</p>` : ''}
                    <p style="margin: 5px 0 0 0; font-size: 11px; color: #0c5460; opacity: 0.8;">‚ö†Ô∏è Estimates based on ALKIS land use data</p>
                </div>
                ` : ''}
                
                <div style="background: #e7f3ff; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #007bff;">
                    <p style="margin: 0 0 5px 0; font-size: 13px; color: #004085; font-weight: bold;">üí∞ Estimated Cooling Effect:</p>
                    <p style="margin: 0; font-size: 14px; font-weight: bold; color: #0066cc;">${cooling}</p>
                </div>
                
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #dee2e6;">
                
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 0 0 10px 0; font-weight: bold; font-size: 14px; color: #495057;">üìä Scoring Breakdown:</p>
                    
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="font-size: 12px;">üî• Heat Priority (40%)</span>
                            <strong style="font-size: 12px;">${heatScore.toFixed(1)}/100</strong>
                        </div>
                        <div style="background: #e9ecef; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #dc3545, #ff6b6b); height: 100%; width: ${heatScore}%;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="font-size: 12px;">üìè Spatial Quality (30%)</span>
                            <strong style="font-size: 12px;">${spatialScore.toFixed(1)}/100</strong>
                        </div>
                        <div style="background: #e9ecef; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #007bff, #66b3ff); height: 100%; width: ${spatialScore}%;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="font-size: 12px;">üë• Social Impact (20%)</span>
                            <strong style="font-size: 12px;">${socialScore.toFixed(1)}/100</strong>
                        </div>
                        <div style="background: #e9ecef; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #28a745, #66cc77); height: 100%; width: ${socialScore}%;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                            <span style="font-size: 12px;">üöú Maintenance (10%)</span>
                            <strong style="font-size: 12px;">${maintenanceScore.toFixed(1)}/100</strong>
                        </div>
                        <div style="background: #e9ecef; height: 6px; border-radius: 3px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #ffc107, #ffdb4d); height: 100%; width: ${maintenanceScore}%;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid ${getColor(score)};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 14px; font-weight: bold; color: #495057;">‚≠ê FINAL SCORE:</span>
                            <span style="font-size: 18px; font-weight: bold; color: ${getColor(score)};">${score.toFixed(2)}/100</span>
                        </div>
                    </div>
                </div>
                
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #dee2e6;">
                
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; font-size: 12px;">
                    <p style="margin: 0 0 8px 0; font-weight: bold; color: #495057;">üìê Coordinates:</p>
                    <p style="margin: 0 0 5px 0; color: #6c757d;">
                        <strong>Lat/Lon (WGS84):</strong><br>
                        ${lat.toFixed(6)}, ${lon.toFixed(6)}
                    </p>
                    <p style="margin: 0; color: #6c757d;">
                        <strong>UTM (EPSG:25832):</strong><br>
                        ${typeof utmX === 'number' ? utmX.toFixed(1) : utmX}, ${typeof utmY === 'number' ? utmY.toFixed(1) : utmY}
                    </p>
                </div>
                
                <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" 
                   style="display: block; margin-top: 15px; padding: 14px; 
                          background: linear-gradient(135deg, #2e7d32 0%, #66bb6a 100%); 
                          color: white; text-align: center; text-decoration: none; 
                          border-radius: 8px; font-weight: bold; font-size: 14px;
                          box-shadow: 0 3px 8px rgba(46, 125, 50, 0.3);">
                    üó∫Ô∏è Navigate with Google Maps
                </a>
                
                <div style="background: #e8f5e9; padding: 10px; margin-top: 10px; 
                            border-radius: 5px; font-size: 11px; border-left: 3px solid #4caf50;">
                    ‚úÖ Data verified current (2020-2025)<br>
                    üì∏ Field verification recommended
                </div>
            </div>
        `, {
            maxWidth: 400
        });

        markers.addLayer(marker);
        individualMarkers.addLayer(marker);
    });

    // Add to map
    map.addLayer(markers);

    // Update stats
    const avgScore = totalScore / locations.length;
    document.getElementById('avgScore').textContent = avgScore.toFixed(1);
    
    // Fit map to markers
    if (locations.length > 0) {
        const bounds = L.latLngBounds(
            locations.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]])
        );
        map.fitBounds(bounds, { padding: [50, 50] });
    }
}

    function showAll() {
        displayLocations(allLocations);
    }

    function showTop50() {
        const top50 = allLocations
            .sort((a, b) => (b.properties.final_score || 0) - (a.properties.final_score || 0))
            .slice(0, 50);
        displayLocations(top50);
    }

    function showExcellent() {
        const excellent = allLocations.filter(f => (f.properties.final_score || 0) >= 90);
        displayLocations(excellent);
        
        if (excellent.length === 0) {
            alert('No locations with score >= 90 in fresh data');
        }
    }

    // Load data on page load
    loadFreshData();
</script>
</body>
</html>